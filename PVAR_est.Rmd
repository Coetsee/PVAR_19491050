---
title: "PVAR_est"
author: "J Coetsee - 19491050"
date: "01/06/2021"
output: pdf_document
---

### PVAR estimation 

# packages and data
```{r}

library(pacman)
p_load("scales", "panelvar", "plm", "tseries", "vars", "gridExtra", "tidyverse")
source("code/growth_fun.R")
theme_set(theme_light())

#setting memory limits (atm limit.size = 311.61)

memory.limit(size=50000)


# reading in data

pvar_data <- read.csv("C:/Projects/Time_Series/PVAR_19491050/data/joined.csv")

#growth rates for gini and pc income:

pvar_data <- pvar_data %>% 
  group_by(State) %>% 
  mutate( Inc_growth = c(NA,diff(realpc_income))/lag(realpc_income, 1), 
          Gini_growth = c(NA,diff(Gini))/lag(Gini, 1)) %>% slice(-1) %>% 
    mutate(Year = ordered(Year),
           st = as_factor(st)) %>% 
  ungroup() %>% 
  select(Year, st, Inc_growth, Gini_growth)

# must be in data.frame format, not tibble. I struggled with this for long
pvar_data <- as.data.frame(pvar_data)
```

# Baseline PVAR estimation - same specification as replicated study

```{r}
#Baseline, it runs, but caps out due to memory issues (error: cannot allocate vector size) (don't run this)

baseline <- pvargmm(dependent_vars = c("Inc_growth", "Gini_growth"),
                             lags = 4,
                             transformation = "fod",
                             data = pvar_data,
                             panel_identifier=c("st", "Year"),
                             steps = c("twostep"),
                             system_instruments = FALSE,
                             max_instr_dependent_vars = 99,
                             max_instr_predet_vars = 99,
                             min_instr_dependent_vars = 2L,
                             min_instr_predet_vars = 1L,
                             collapse = TRUE
)

summary(baseline)

#IRFs

pvar_irf <- oirf(baseline, n.ahead = 15)

plot(pvar_irf, ylim = c(-0.01, 0.01))


#IRF's confidence bands: 

pvar_conf <- bootstrap_irf(baseline,
  typeof_irf = "OIRF",
  n.ahead = 20,
  nof_Nstar_draws = 10,
  confidence.band = 0.95)

plot(pvar_irf, pvar_conf)

# fevd:

fevd_baseline <- fevd_orthogonal(baseline, n.ahead = 20)

plot(fevd_baseline$Gini_growth)
```

Counterfactual, period without 2005:2018:

```{r}

pvar_19302005 <- pvar_data %>% 
  filter(Year %in% c(1930:2005))

model19302005 <- pvargmm(dependent_vars = c("Inc_growth", "Gini_growth"),
                             lags = 4,
                             transformation = "fod",
                             data = pvar_19302005,
                             panel_identifier=c("st", "Year"),
                             steps = c("twostep"),
                             system_instruments = FALSE,
                             max_instr_dependent_vars = 99,
                             max_instr_predet_vars = 99,
                             min_instr_dependent_vars = 2L,
                             min_instr_predet_vars = 1L,
                             collapse = TRUE
)

summary(model19302005)

#IRFs

pvar_irf_19302005 <- oirf(model19302005, n.ahead = 20)

plot(pvar_irf_19302005)


#IRF's confidence bands: 

pvar_conf_19302005 <- bootstrap_irf(model19302005,
  typeof_irf = "OIRF",
  n.ahead = 20,
  nof_Nstar_draws = 10,
  confidence.band = 0.95)

plot(pvar_irf_19302005, pvar_conf_19302005)

# fevd:

fevd_19302005 <- fevd_orthogonal(model19302005, n.ahead = 20)

plot(fevd_19302005$Gini_growth)

```


Only Small dataset

```{r}
### trying with a smaller dataset: just the new data 2005:2018

pvar_small <- pvar_data %>% 
  group_by(st) %>% 
  filter(Year %in% c("2005":"2018"))
 
# as df:

pvar_small <- as.data.frame(pvar_small)

# running var model:

test_small <- pvargmm(dependent_vars = c("Gini_growth", "Inc_growth"),
                             lags = 4,
                             transformation = "fod",
                             data = pvar_small,
                             panel_identifier=c("st", "Year"),
                             steps = c("twostep"),
                             system_instruments = FALSE,
                             max_instr_dependent_vars = 99,
                             max_instr_predet_vars = 99,
                             min_instr_dependent_vars = 2L,
                             min_instr_predet_vars = 1L,
                             collapse = FALSE
)

summary(test_small)

# IRF's:

pvar_small_irf <- oirf(test_small, n.ahead = 12)

plot(pvar_small_irf)

#girf:

pvar_girf <- girf(test_small, n.ahead = 12,ma_approx_steps = 13 )
plot(pvar_girf)



# Confidence intervals:

pvar_small_conf <- bootstrap_irf(test_small,
  typeof_irf = "OIRF",
  n.ahead = 12,
  nof_Nstar_draws = 50,
  confidence.band = 0.95)

plot(pvar_small_irf, pvar_small_conf)

#fevd_small dataset;

fevd_small <- fevd_orthogonal(test_small, n.ahead = 12)
plot(fevd_small$Inc_growth)

fevd_small_df <- as.data.frame(fevd_small) %>% 
  mutate(year = round(1:12)) %>% 
  gather(Measure, value = Value, Gini_growth.Gini_growth:Inc_growth.Inc_growth)


#fevd income plot:

income_fevd <- fevd_small_df %>% 
  group_by(Measure) %>% 
  filter(Measure == c("Inc_growth.Inc_growth", "Inc_growth.Gini_growth")) %>% 
  ggplot()+
  geom_line(aes(y = Value, x = year, colour = Measure)) +
  labs(title = "Income Growth",
       y = "",
       x = "Years") +
  theme(legend.position = "none") +
  scale_x_continuous(breaks =seq(1,12, by = 1)) +
  scale_y_continuous(labels = percent)


#fevd Gini plot:

gini_fevd <- fevd_small_df %>% 
  group_by(Measure) %>% 
  filter(Measure == c("Gini_growth.Gini_growth", "Gini_growth.Inc_growth")) %>% 
  ggplot()+
  geom_line(aes(y = Value, x = year, colour = Measure)) +
  labs(title = "Gini Growth",
       y = "",
       x = "Years") +
  theme(legend.position = "none")+
  scale_x_continuous(breaks =seq(1,12, by = 1)) +
  scale_y_continuous(labels = percent)


fevd_plot <- grid.arrange(income_fevd, gini_fevd, nrow = 1,
                          bottom = "Income in Blue and Gini in Red")

```


### Regional PVARs

1 = 
2 = 
3 = 
4 = 
5 = 
6 = 
7 = 
8 = 

```{r}
#reading in income data:

regional <- read.csv("C:/Projects/Time_Series/PVAR_19491050/data/joined.csv")



```





















example:

```{r}
## Not run:
library(panelvar)
data(abdata)

#it works for both the dataset without the matrix of years. Both deliver the same results. 

ex3_abdata <-pvargmm(
    dependent_vars = c("emp"),
    lags = 4,
    predet_vars = c("wage"),
    exog_vars = c("cap"),
    transformation = "fd",
    data = abdata,
    panel_identifier = c("id", "year"),
    steps = c("twostep"),
    system_instruments = TRUE,
    max_instr_dependent_vars = 99,
    max_instr_predet_vars = 99,
    min_instr_dependent_vars = 2L,
    min_instr_predet_vars = 1L,
    collapse = FALSE
)
## End(Not run)
summary(ex3_abdata)


### OR

data("Dahlberg")
## Not run: 
ex1_dahlberg_data <- pvargmm(dependent_vars = c("expenditures", "revenues", "grants"),
                             lags = 1,
                             transformation = "fod",
                             data = Dahlberg,
                             panel_identifier=c("id", "year"),
                             steps = c("twostep"),
                             system_instruments = FALSE,
                             max_instr_dependent_vars = 99,
                             max_instr_predet_vars = 99,
                             min_instr_dependent_vars = 2L,
                             min_instr_predet_vars = 1L,
                             collapse = FALSE
)

summary(ex1_dahlberg_data)

#IRF's of example:

example_irf <- oirf(ex1_dahlberg_data, n.ahead = 12)

plot(example_irf)

bootstrap <- bootstrap_irf(ex1_dahlberg_data,
  typeof_irf = "OIRF",
  n.ahead = 12,
  nof_Nstar_draws = 2,
  confidence.band = 0.95)

plot(example_irf, bootstrap)

#fevd:

data("ex1_dahlberg_data")
example_fevd <- fevd_orthogonal(ex1_dahlberg_data, n.ahead = 12)

plot(example_fevd$expenditures)


```

# baseline with system instruments = TRUE

```{r}
baselineGMM <- pvargmm(dependent_vars = c("Inc_growth", "Gini_growth"),
                             lags = 4,
                             transformation = "fod",
                             data = pvar_data,
                             panel_identifier=c("st", "Year"),
                             steps = c("twostep"),
                             system_instruments = TRUE,
                             max_instr_dependent_vars = 99,
                             max_instr_predet_vars = 99,
                             min_instr_dependent_vars = 2L,
                             min_instr_predet_vars = 1L,
                             collapse = TRUE
)

summary(baselineGMM)

#IRFs

pvargmm_irf <- oirf(baselineGMM, n.ahead = 12)

plot(pvargmm_irf)


```

